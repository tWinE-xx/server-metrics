<html>
    <head>
        <!-- http://www.chartjs.org/ -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.3.0/Chart.bundle.js"></script>
    </head>
    <body>
        <h1>visualv8</h1>

        <div style="width:100%;">
            <div id="messagesDiv" style="background: yellow"></div>
            <div>
                <button id="memoryDiffButton" onclick="memoryDiffButtonClick()">Memory diff</button>
                <button id="gcButton" onclick="gcButtonClick()">Run GC cycle</button>
            <div>
            <div id="memoryDiffDiv"></div>
            <hr/>
            <canvas id="memoryChart" width="400" height="200"></canvas>
            <hr/>
            <canvas id="cpuChart" width="400" height="200"></canvas>
        </div>

        <script src="/socket.io/socket.io.js"></script>  
        <script>  
            var socket = io.connect('/');

            function report(message, cleanAfter){
                var timeout = null;
                document.getElementById('messagesDiv').innerHTML = message;
                if (cleanAfter){
                    timeout = setTimeout(function(){
                        document.getElementById('messagesDiv').innerHTML = '';
                    }, cleanAfter);
                }
            }

            function memoryDiffButtonClick(){
                socket.emit('snapshot-diff');
            }

            function gcButtonClick(){
                socket.emit('gc');
                report('calling GC collect, please wait..');
            }
            socket.on('gc-result', function(data) {
                report(data.message, 5000);
            });

            socket.on('onConnect', function(data) {
                console.log('server:', data.message);
            });
            socket.on('cpu', function(data) {
                //console.log('upc', data);
                updateCpuChart(cpuChart, data.message);
            });
            socket.on('memory', function(data) {
                //console.log('memory', data);
                updateMemoryChart(memoryChart, data.message);
            });
            socket.on('snapshot-diff-result', function(data) {
                //console.log('memory', data);
                document.getElementById('memoryDiffDiv')
                    .innerHTML = 
                        '<ul>\
                            <li>String: '+data.message.String+'</li>\
                            <li>Array: '+data.message.Array+'</li>\
                            <li>Object: '+data.message.Object+'</li>\
                            <li>Timeout: '+data.message.Timeout+'</li>\
                        </ul>';
            });

            var maxShownDots = -1;

            function updateCpuChart(chart, data){
                if (maxShownDots < 0 || chart.data.datasets[0].data.length<maxShownDots)
                    chart.data.datasets[0].data.push(data);
                else{
                    chart.data.datasets[0].data = chart.data.datasets[0].data.splice(1,chart.data.datasets[0].data.length-1);
                    chart.data.datasets[0].data.push(data);                                
                } 
                chart.update();
            }

            function updateMemoryChart(chart, data){
                if (maxShownDots < 0 || chart.data.datasets[0].data.length<maxShownDots){
                    chart.data.datasets[0].data.push({x:data.time, y:data.rss});//rss
                    chart.data.datasets[1].data.push({x:data.time, y:data.heapTotal});//heapTotal
                    chart.data.datasets[2].data.push({x:data.time, y:data.heapUsed});//heapUsed
                } else {
                    chart.data.datasets[0].data = chart.data.datasets[0].data.splice(1,chart.data.datasets[0].data.length-1);
                    chart.data.datasets[1].data = chart.data.datasets[1].data.splice(1,chart.data.datasets[1].data.length-1);
                    chart.data.datasets[2].data = chart.data.datasets[2].data.splice(1,chart.data.datasets[2].data.length-1);
                    chart.data.datasets[0].data.push({x:data.time, y:data.rss});//rss
                    chart.data.datasets[1].data.push({x:data.time, y:data.heapTotal});//heapTotal
                    chart.data.datasets[2].data.push({x:data.time, y:data.heapUsed});//heapUsed
                }
                chart.update();
            }

            var ctxMemoryChart = document.getElementById("memoryChart");
            var memoryChart = new Chart(ctxMemoryChart, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'rss',
                            data: []
                        }, {
                            label: 'heapTotal',
                            data: []
                        }, {
                            label: 'heapUsed',
                            data: []
                        }]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                display: false,
                                type: 'linear',
                                position: 'bottom'
                            }],
                            yAxes: [{
                                ticks: {
                                    beginAtZero:true
                                }
                            }]
                        }
                    }
                });

            var ctxCpuChart = document.getElementById("cpuChart");
            var cpuChart = new Chart(ctxCpuChart, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'CPU % Usage',
                            data: []
                        }]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                display: false,
                                type: 'linear',
                                position: 'bottom'
                            }],
                            yAxes: [{
                                ticks: {
                                    beginAtZero:true,
                                    max: 100
                                }
                            }]
                        }
                    }
                });           
        </script>  
    </body>
</html>